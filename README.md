# DLC_Starter

免許証タッチしないと運転できないシステムです。

Arduino を用いて、日本の運転免許証の有効期限を確認して、有効な免許である場合のみエンジン始動可能にします。

従来免許証、マイナ免許証の両方に対応しています。

WiFi 機能を生かし、設定はスマホからワイヤレスで行います。

## 注意事項

### 防犯目的には使用できません

掲載している回路図・ソースコードは、無効化(電源を切る)するとエンジンが かかる 側になります。

あくまでも「うっかり防止」のためのシステムです。

有効期限が印字されないマイナ免許証の期限切れ防止、マイナ・従来の2枚持ちで頻繁に入れ替えていて忘れることによる不携帯防止を目的としたものです。

### 車両で試される場合

**完全自己責任でお願いいたします。**

品質保証はしていません。無効化時にエンジンが かからない 側の配線をすると、帰れなくなるリスクがあります。

**始動制御に電磁リレーを使用する場合「ノーマリークローズ接点(B接点)」側を使うように配線・プログラムします。**

**そのうえで リレー または 電源 の配線は、工具なしで容易に外せる方法で接続し、工具なしで容易に外せる場所に接続部を出しておきます。** 

(例：ギボシ端子で接続し、ギボシ端子部分をハンドル下の見える場所に出しておく)

ノーマリークローズ接点を使用すれば、通電しなければエンジンが かかる 側で無効化されますから帰れなくなるリスクを下げられます。

またノーマリークローズ接点を用いることで、スターターリレー用に設計されたリレーでなくてもクランキング中の電圧低下によるリスクを下げられます。 

(クランキング中電圧低下 → コイル通電電流低下 → 接点圧力低下 → 接触抵抗大 → 発熱 リスク)

### マイナ免許証暗証番号の平文保管について

EEPROM に暗証番号を平文で保管しています。漏洩は自己責任でお願いいたします。

main.cpp の DEVELOP_MODE を有効にすると、内部に保管だけでなく、起動時にUSBシリアル出力で平文で画面出力します。

### 使用ライブラリのライセンスについて

DLC starter 自体は MIT ライセンスで公開していますが、ビルドするとLGPLライセンスのライブラリが静的リンクされます。

このリポジトリでJGPLライセンスのライブラリの "再頒布" はしていません。各々の開発環境で Arduino からダウンロードされ各PC内でリンクされます。

https://github.com/arduino/ArduinoCore-renesas/

うち LGPLのライブラリ(DLC starter から include している階層であり、ライブラリ内の芋づる式includeは未確認です)

+ SPI
+ EEPROM
+ WiFi3 

### 免許証の仕様書V10を合わせてご覧ください。

「免許証 仕様書V10」でGoogle検索し、警察庁が公開している『原議保存期間 5年(令和12年3月31日まで)』pdfをダウンロードします。

## 基本操作

### 通常モード

電源を入れ、「始動不可」LEDが点灯し「免許証タッチしてください」と音声合成が流れたら免許証をタッチします。

免許証をタッチせずエンジンをかけようとしても「免許証をタッチしてください」と流れるだけでエンジンはかかりません。

マイナ免許証・従来免許証は自動判定しますからどちらでもタッチ可能です。

#### 従来免許証の場合

そのまま従来免許証をタッチします。

共通データ要素から有効期限を読み出しますから暗証番号は不要です。

#### 暗証番号が未設定のマイナ免許証の場合

そのままマイナンバーカードをタッチします。

WEF01 を読んで暗証番号が設定されていないことを確認し、仕様書既定のDPIN ("0x2A 0x2A 0x2A 0x2A ")で認証しますから暗証番号は不要です。

#### 暗証番号が設定されたマイナ免許証の場合

事前に暗証番号を設定し、ドライバー選択しておく必要があります。

マイナンバーカードをタッチする前に「設定/モード」ボタンを押すと「マイナ免許 ドライバー X」と流れてドライバー切り替わります。短周期で繰り返し押すと番号のみの読み上げになります。

**※連打しているとRC-S660/Sがフリーズする不具合があります。Arduino UNO R4 WiFi 本体の TX LED が点滅しなくなったらリセットします**

デフォルトではドライバー1が選択されますから、一人で乗る車の場合はドライバー1に登録しておけばタッチするだけの操作となります。

ドライバーを選択したら、マイナンバーカードをタッチします。

暗証番号ミスの場合はカード保護のためアナウンス無限ループに入りますので、リセットするか電源を入れ直して再トライします。

暗証番号が記憶されていないドライバーを選択した場合は、登録を促すアナウンスが流れます。

### 設定モード

マイナ免許証暗証番号事前登録と、RTCの時刻設定は、設定モードで起動してスマホからWiFi経由で行います。

スマホ側はブラウザを使用しますから、特別なアプリは要りません。

「設定/モード」ボタンを押しながらリセットするか電源を入れると、設定モードで起動します。

「設定モードで起動します」と流れ、Arduino UNO R4 WiFi 本体のドットマトリクスLEDにWiFiマークが表示されます。

接続先SSIDとIPアドレスは、arduino_secret.hでの設定によります。


**スマホを機内モードに入れてから　Arduino Uno に接続しないと設定画面に接続できません。**

モバイル回線側が接続されていると、~~WAN 側を探しに行ってページが見つからないエラーになるか~~ (上位2バイトをローカルIP割り当て範囲の 192.168 に固定したことで解消？)、検索キーワードとして扱われてIPアドレスに関する検索結果が出てきます。


## ソフトウェア


### 動作確認済み開発環境

OS : Windows 11 Pro 23H2/24H2

Visual Studio Code : 1.98 (Japanese Language Pack 有効)

IDE : PlatformIO IDE 3.3.4 (VScode 拡張機能)

※ ハードウェアは Arduino を使っていますが PlatformIO 前提のコードになっており Arduino IDE ではビルドできません

※ Clean してから Build し直さないと WiFi が繋がらなくなるようです

### 設定ファイル arduino_secrets.h

arduino_secrets_template.h を arduino_secrets.h にリネームして使用します。


| 種別 | 定数名 | 用途 | 設定値 | 不要な場合 |
| :--- | :--- | :--- | :--- | :--- |
| 必須 | SECRET_SSID| 設定画面アクセスポイントSSID | 英数字:32文字まで | － |
| オプション | SECRET_PASS | 設定画面アクセスポイントWPAパスワード | 英数字:8~63文字 | コメントアウト or 削除 or ""を定義 |
| 必須 | SECRET_SECURITY_NO | 暗証番号設定画面用<br/>いたずら防止用暗証番号 |　数字:0~9999 | － |
| オプション | SECRET_IP_ADDR_UPPER<br/>SECRET_IP_ADDR_LOWER | 設定画面IPアドレス |　数字:1～254 | 削除 or コメントアウト |
 
 ※SECRET_IP_ADDR_UPPER と SECRET_IP_ADDR_LOWER は、片方のみの設定はできません(片方のみ定義の場合は未設定扱いになります)

 ※SECRET_IP_ADDR_UPPER と SECRET_IP_ADDR_LOWER 未設定の場合は、Arduino WiFi ライブラリのデフォルト値となります

### カスタマイズ

#### カードリーダーを変える

JpDrvLicNfcCommand\jpdlc_base_reader_if がラッパー層となっています。

### ハードウェア

#### 主要部品

マイコンボード : Arduino Uno R4 WiFi

NFCカードリーダ : SONY RC-S/660S

音声合成LSI(オプション) : AQUEST AquesTalk pico ATP301x シリーズ

その他 : 電磁リレー、トランジスタ、抵抗など

### 回路例

スタータ回路に電磁リレーを割り込ませる、最もスタンダードな構成例です。

電磁リレーはノーマリークローズ接点を使用し、故障時は電源を切ればエンジンが かかる 側で無効化されます。

**※スタータのB端子回路(バッテリーにつながっている太い線)にリレーを割り込ませると燃えます。C端子回路(プルインコイルにつながっている細い線)かスタータリレーのコイル回路に割り込ませます。**

